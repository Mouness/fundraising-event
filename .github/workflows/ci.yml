name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, Initital-project ]
  pull_request:
    branches: [ main, master, Initital-project ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Generate Prisma Client
        run: pnpm db:generate
      - name: Build
        run: pnpm build

  lint-commit:
    name: Lint Commit Messages
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: wagoid/commitlint-github-action@v6

  format-code:
    name: Code Formatting
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Check Formatting
        run: pnpm format:check

  unit-tests:
    name: Unit Tests
    needs: build
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Generate Prisma Client
        run: pnpm db:generate
      - name: Build Workspace Dependencies
        run: pnpm build
      - name: Test
        run: pnpm test
      
      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: "**/coverage/**"
          retention-days: 7

  e2e-tests:
    name: E2E Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Install Playwright Browsers
        run: pnpm --filter @fundraising/e2e exec playwright install --with-deps
      - name: Run E2E Tests
        run: pnpm --filter @fundraising/e2e test
        env:
          CI: true
      - name: Upload Playwright Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: apps/e2e/playwright-report/
          retention-days: 7

  lint-code:
    name: Code Linting
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Generate Prisma Client
        run: pnpm db:generate
      - name: Lint
        run: pnpm lint

  scan-code:
    name: Security Scan
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Security Audit
        run: pnpm audit --prod

  dockerize:
    name: Docker Build
    needs: [unit-tests, e2e-tests, lint-code, scan-code, lint-commit, format-code]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/api/deploy/Dockerfile
          push: false
          load: true
          tags: fundraising-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Web Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/web/deploy/Dockerfile
          build-args: |
            VITE_API_URL=${{ vars.VITE_API_URL }}
            VITE_STRIPE_PUBLIC_KEY=${{ secrets.VITE_STRIPE_PUBLIC_KEY }}
          push: false
          load: true
          tags: fundraising-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan API Image
        uses: anchore/scan-action@v3
        with:
          image: "fundraising-api:latest"
          fail-build: true
          severity-cutoff: critical

      - name: Scan Web Image
        uses: anchore/scan-action@v3
        with:
          image: "fundraising-web:latest"
          fail-build: true
          severity-cutoff: critical

  deploy-docs:
    name: Deploy Documentation
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/Initital-project'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - run: echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV 
      - uses: actions/cache@v4
        with:
          key: mkdocs-material-${{ env.cache_id }}
          path: .cache
          restore-keys: |
            mkdocs-material-
      - run: pip install mkdocs-material 
      - run: mkdocs gh-deploy --force

  release:
    name: Semantic Release
    needs: [unit-tests, e2e-tests, lint-code, scan-code, lint-commit, format-code]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  self-heal:
    name: Self-Healing Agent
    needs: [unit-tests, e2e-tests, lint-code, scan-code, lint-commit, format-code]
    if: failure() && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
        contents: write
        pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Generate Prisma Client
        run: pnpm db:generate
      
      - name: Re-run Failure to Capture Log
        run: |
          # Try to identify the failure by running lint first (it's fastest)
          pnpm lint > failure.log 2>&1 || pnpm test > failure.log 2>&1 || true
      
      - name: AI Healing Agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/healing-agent.js failure.log
      
      - name: Create Pull Request with Fix
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ai: self-healing fix for CI failure"
          branch: ai-healing-fix
          title: "ðŸ¤– AI-Generated Fix for CI Failure"
          body: |
            This PR was automatically generated by the AI Healing Agent to fix a CI failure.
            
            Logs analyzed:
            ```
            $(cat healing_summary.txt)
            ```
          delete-branch: true
